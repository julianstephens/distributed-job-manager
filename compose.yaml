include:
  - logging.yml

services:
  jobsvc:
    container_name: jobsvc
    build:
      context: .
      dockerfile: services/jobsvc/Dockerfile
      target: ${ENV}
      args:
        APP_HOME: ${APP_HOME}
    env_file: ".env"
    ports:
      - ${JOB_SERVICE_PORT}:${JOB_SERVICE_PORT}
    links:
      - cassandra
    volumes:
      - .:${APP_HOME}

  schedulingsvc:
    container_name: schedulingsvc
    build:
      context: .
      dockerfile: services/schedulingsvc/Dockerfile
      target: ${ENV}
      args:
        APP_HOME: ${APP_HOME}
    env_file: ".env"
    ports:
      - ${SCHEDULING_SERVICE_PORT}:${SCHEDULING_SERVICE_PORT}
    links:
      - cassandra
      - rabbitmq
    volumes:
      - .:${APP_HOME}

  worker:
    container_name: worker
    build:
      context: .
      dockerfile: services/workersvc/Dockerfile
      target: ${ENV}
      args:
        APP_HOME: ${APP_HOME}
    privileged: true
    env_file: ".env"
    ports:
      - ${WORKER_SERVICE_PORT}:${WORKER_SERVICE_PORT}
    links:
      - cassandra
      - rabbitmq
    volumes:
      - .:${APP_HOME}

  rabbitmq:
    image: rabbitmq:latest
    container_name: rabbitmq
    restart: always
    ports:
      - ${RABBIT_PORT}:${RABBIT_PORT}
      - 15672:15672
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBIT_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBIT_PASSWORD}
    configs:
      - source: rabbitmq-plugins
        target: /etc/rabbitmq/enabled_plugins
    volumes:
      - rabbitmq-lib:/var/lib/rabbitmq/
      - rabbitmq-log:/var/log/rabbitmq

  cassandra:
    container_name: cassandra
    image: cassandra:latest
    ports:
      - 9042:9042
    environment:
      - CASSANDRA_USER=${DB_USERNAME}
      - CASSANDRA_PASSWORD=${CASS_PASSWORD}
    volumes:
      - djm_cassdata:/var/lib/cassandra

configs:
  rabbitmq-plugins:
    content: "[rabbitmq_management]."

volumes:
  djm_pgdata:
  djm_cassdata:
  rabbitmq-lib:
    driver: local
  rabbitmq-log:
    driver: local

